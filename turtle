os.loadAPI("apis/network")
os.loadAPI("apis/miner")
os.loadAPI("apis/navigation")


function pingHandler(id)
    print("sending pong")
    network.send(id, "pong")
end

function shutDownHandler(id, message)
    network.send(id, "shutting down")
    network.closeConnection()
end

function positionHandler(id)
    print("sending position")
    local x, y, z = gps.locate()
    if not x then x = -1;y=-1;z=-1 end
    network.send(id, "pos:" .. x .. "," .. y .. "," .. z)
end

-- main --
network.addMessageHandler("ping", pingHandler)
network.addMessageHandler("shutdown", shutDownHandler)
network.addMessageHandler("position", positionHandler)

network.init()
navigation.init()
miner.init(navigation, network)

parallel.waitForAll(miner.run, network.run)